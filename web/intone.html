<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Intone</title>
<link href="css/bootstrap.min.css" rel="stylesheet">
<script type="text/javascript" src="js/lib/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/jq-ext.js"></script>
<script type="text/javascript" src="js/lib/store.js"></script>
<script type="text/javascript" src="js/lib/bootstrap.min.js"></script>
<link type="text/css" rel="stylesheet" href="css/intone.css">
</head>
<body>
<div style="margin: 20px;">
    
	<audio controls = 'controls'> 
	    <source id='mp3' src=''/>
	</audio>

	<div style="float: right">
	    <a id="back" href="index.html" target="_self">Back to list</a> | 
		<a id="edit">Edit</a>	
	</div>
    <div style="padding:10px 0;">
    <span id="chartName" style="font-size:150%;font-weight:bold"></span> 
    	<button type="button" class="btn btn-default" id="again">
	      <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Replay
	    </button>
    	<button type="button" class="btn btn-default" id="reload">
	      <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Reload
	    </button>	    
	</div>	
	<table id="chartTable" contenteditable="false" cellspacing ="30px" class="table" style="width:100%"></table>
	<div id='word'> </div>
	<img id="wordimg" onerror="this.style.display='none'""/>
</div>
</body>
<script type="text/javascript">
$(document).ready(function() {
	var wordlist = load();
	if(wordlist.length == 0) return;
	

	var token,isPlaying=false, lastHighLight;
	var index = 0;
	$.ajax({
		url : "http://api.naturalreaders.com/v2/auth/requesttoken?callback=velo&appid=pelc790w2bx&appsecret=2ma3jkhafcyscswg8wgk00w0kwsog4s",
	    dataType:'JSONP'
	}).done(function(response) {
		token = response.requesttoken;
		index = 0;
		playAWord();    
	});
	$("#again").click(function(){
		$('audio:first-child').unbind('ended');
		index = 0;
		playAWord();
	});
	$("#reload").click(function(){
		index = lastHighLight;
		playAWord();
	});
	
	function bindAudioEnded(){
			$('audio:first-child').bind('ended', function(){
			console.log("play "+(index-1)+" : "+wordlist[index-1]);
			console.log($('audio')[0].duration);
		    setTimeout(function(){playAWord();}, $('audio')[0].duration*1000);		    
		});
	}
	
	function playAWord(){				
		if(index > 0) {
			$('#word'+lastHighLight).removeClass('highlight');			
		} else if(index == 0){
			bindAudioEnded();
			$('#word'+lastHighLight).removeClass('highlight');
		}
 		$('#word'+index).addClass('highlight');
 		lastHighLight = index;
    	$('#wordimg').attr('src', "img/"+wordlist[index].toLowerCase()+".jpg");
    	$('#wordimg').css("display", "block");
    	
		var url = 'http://api.naturalreaders.com/v2/tts/?t='+ wordlist[index] +'&r=1&s=-10&requesttoken=' + token;
		$('audio:first-child').attr('src',url); 
	    $('audio')[0].play();
	    isPlaying = true;
		index++;
		if(index > wordlist.length-1){
			$('audio:first-child').unbind('ended');
		}
	}

	function load() {
	    var chart = window.store.get($.getUrlParam('chart'));
	    $('#chartName').text(chart.name);
		var ths="";
		var tds="";

		$("#edit").attr('href','editChart.html?chart='+$.getUrlParam('chart'));

		var wordlist=[];
		for(var i = 0; i< chart.content.length; i++){
			ths = ths + "<th>" +chart.content[i].name+"</th>";
			var words = chart.content[i].words;
			if(words == undefined) continue;
			var list="";
			for(var j=0; j< words.length; j++)
				if (words[j] != ""){
				    list = list+ "<div id='word"+wordlist.length+"'>" + words[j] + "</div>";
					wordlist.push(words[j]);
				} else {
					list = list+ "<br>"
				}
			tds = tds +"<td>" + list + "</td>";
		}
		$("#chartTable").append("<tr>"+ ths +"</tr>");
		$("#chartTable").append("<tr>"+ tds +"</tr>");
		return wordlist;
	}
});	
</script>
</html>