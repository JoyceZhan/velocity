<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script type="text/javascript" src="js/lib/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="js/jq-ext.js"></script>
<script type="text/javascript" src="js/lib/store.js"></script>
</head>
<body>
<audio controls='controls'> 
    <source id='mp3' src=''/>
</audio>
<input type="button" id="again" value="Again"></input>
<table id="chartTable" contenteditable="false" cellspacing ="30px"></table>
<div id='word'> </div>
<img id="wordimg" onerror="this.style.display='none'""/>
<div>
	<a id="edit">Edit</a>	
</div>
</body>
<script type="text/javascript">
$(document).ready(function() {
	var wordlist = load();
	if(wordlist.length == 0) return;
	
	var token,isPlaying=false;
	var index = 0;
	$.ajax({
		url : "http://api.naturalreaders.com/v2/auth/requesttoken?callback=velo&appid=pelc790w2bx&appsecret=2ma3jkhafcyscswg8wgk00w0kwsog4s",
	    dataType:'JSONP'
	}).done(function(response) {
		token = response.requesttoken;
		$('#word').text("Intoning start ...");
		isPlaying = true;
		index = 0;
		playAWord();
		$('audio:first-child').bind('ended', function(){
			console.log("play "+(index-1)+" : "+wordlist[index-1]);
			console.log($('audio')[0].duration);
		    setTimeout(function(){playAWord();}, $('audio')[0].duration*1000);		    
		});
	});
	$("#again").click(function(){
		index = 0;
		playAWord();
	});
	
	function playAWord(){		
    	$('#word').text(wordlist[index]);
    	$('#wordimg').attr('src', "img/"+wordlist[index].toLowerCase()+".jpg");
    	$('#wordimg').css("display", "block");
    	
		var url = 'http://api.naturalreaders.com/v2/tts/?t='+ wordlist[index] +'&r=1&s=-10&requesttoken=' + token;
		$('audio:first-child').attr('src',url); 
		$('audio')[0].play();
		index++;
		if(index > wordlist.length-1){
			$('audio:first-child').unbind('ended');
		}
	}

	function load() {
	    var chart = window.store.get($.getUrlParam('chart'));
		var ths="";
		var tds="";
		var list="";
		for(var i = 0; i< chart.content.length; i++){
			ths = ths + "<th>" +chart.content[i].name+"</th>";
			if(chart.content[i].words){
				list = chart.content[i].words.join("<br>");
				
			}
			tds = tds +"<td>" + list + "</td>";
		}
		$("#chartTable").append("<tr>"+ ths +"</tr>");
		$("#chartTable").append("<tr>"+ tds +"</tr>");
	
		$("#edit").attr('href','editChart.html?chart='+$.getUrlParam('chart'));
		var ths="";
		var tds="";
		var wordlist=[];
		for(var i = 0; i< chart.content.length; i++){
			var words = chart.content[i].words;
			if(words == undefined) continue;
			for(var j=0; j< words.length; j++)
				if (words[j] != ""){
					wordlist.push(words[j]);
				}			
		}
		return wordlist;
	}
});	
</script>
</html>